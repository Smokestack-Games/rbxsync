name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # Build CLI binaries for each platform
  build-cli:
    name: Build CLI (${{ matrix.name }})
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macos-aarch64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: windows-x86_64
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build CLI
        run: cargo build --release --target ${{ matrix.target }} -p rbxsync

      - name: Rename binary (Unix)
        if: runner.os != 'Windows'
        run: |
          cp target/${{ matrix.target }}/release/rbxsync rbxsync-${{ matrix.name }}

      - name: Rename binary (Windows)
        if: runner.os == 'Windows'
        run: |
          copy target\${{ matrix.target }}\release\rbxsync.exe rbxsync-${{ matrix.name }}.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.name }}
          path: rbxsync-${{ matrix.name }}*

  # Build plugin and VS Code extension (only needs to run once)
  build-assets:
    name: Build Plugin & Extension
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build CLI (for plugin build)
        run: cargo build --release -p rbxsync

      - name: Build Plugin
        run: ./target/release/rbxsync build-plugin

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build VS Code Extension
        working-directory: rbxsync-vscode
        run: |
          npm ci
          npm run build
          npx vsce package

      - name: Upload plugin
        uses: actions/upload-artifact@v4
        with:
          name: plugin
          path: build/RbxSync.rbxm

      - name: Upload VS Code extension
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension
          path: rbxsync-vscode/*.vsix

  # Create release with all artifacts
  release:
    name: Create Release
    needs: [build-cli, build-assets]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        run: |
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s" $PREV_TAG..HEAD --no-merges)
          else
            CHANGES=$(git log --pretty=format:"- %s" --no-merges -10)
          fi

          cat > changelog.md << 'EOF'
          ## Downloads

          ### CLI (Pre-built Binaries)
          | Platform | Download |
          |----------|----------|
          | macOS (Apple Silicon) | `rbxsync-macos-aarch64` |
          | macOS (Intel) | `rbxsync-macos-x86_64` |
          | Windows | `rbxsync-windows-x86_64.exe` |

          ### Quick Install

          **macOS:**
          ```bash
          curl -fsSL https://raw.githubusercontent.com/devmarissa/rbxsync/master/scripts/install.sh | sh
          ```

          **Windows (PowerShell):**
          ```powershell
          irm https://raw.githubusercontent.com/devmarissa/rbxsync/master/scripts/install.ps1 | iex
          ```

          ### Other Downloads
          - **RbxSync.rbxm** - Roblox Studio plugin
          - **rbxsync-*.vsix** - VS Code extension (or install from [Marketplace](https://marketplace.visualstudio.com/items?itemName=rbxsync.rbxsync))

          ## Changes

          EOF
          echo "$CHANGES" >> changelog.md

      - name: Setup Node (for vsce)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Publish VS Code Extension
        working-directory: artifacts/vscode-extension
        run: npx vsce publish --pat ${{ secrets.VSCE_PAT }} --packagePath *.vsix
        continue-on-error: true

      - name: Publish to Open VSX
        working-directory: artifacts/vscode-extension
        run: npx ovsx publish *.vsix -p ${{ secrets.OPEN_VSX_PAT }}
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: RbxSync ${{ steps.version.outputs.VERSION }}
          body_path: changelog.md
          files: |
            artifacts/cli-*/*
            artifacts/plugin/*
            artifacts/vscode-extension/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
